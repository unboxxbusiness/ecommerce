
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAdmin() {
      // Check if the user is an admin by looking at their custom claim.
      // This is more secure than checking a document field.
      // You would set this claim using the Firebase Admin SDK.
      return request.auth.token.admin == true;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Products: Publicly readable, admin-only write access
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Orders: Users can create and read their own orders. Admin can read all.
    match /orders/{orderId} {
      allow read: if isOwner(resource.data.customerEmail) || isAdmin();
      allow create: if request.auth != null && request.resource.data.customerEmail == request.auth.email;
      allow update, delete: if isAdmin();
    }

    // Customers: Users can create their own document, and read/update their own data.
    match /customers/{userId} {
        // A user can create their own customer document.
        // The role must not be 'admin' unless the request is from an existing admin.
        allow create: if isOwner(userId) && (request.resource.data.role != 'admin' || isAdmin());
        // A user can read or update their own data. Admins can do anything.
        allow read, update: if isOwner(userId) || isAdmin();
        // Only admins can delete customer accounts.
        allow delete: if isAdmin();
    }
    
    // Coupons: Users can only check for active coupons. Admins can manage them.
    match /coupons/{couponId} {
        allow read: if request.auth != null && resource.data.isActive == true;
        allow list, write: if isAdmin();
    }

    // Pages: Published pages are public. Admins can manage them.
    match /pages/{pageId} {
        allow read: if resource.data.isPublished == true;
        allow write: if isAdmin();
        allow list: if isAdmin(); // Only admins can list all pages
    }
    
    // Site Content: Only admins can read or write this document.
    match /siteContent/main {
      allow read, write: if isAdmin();
    }
  }
}
